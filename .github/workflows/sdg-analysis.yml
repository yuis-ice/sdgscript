name: SDGScript Analysis

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  sdg-analysis:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Install SDGScript
      run: npm install -g sdgscript
    
    - name: Run SDGScript Analysis
      run: |
        sdgscript analyze src/ --format json -o sdg-report.json
        sdgscript analyze src/ --format html -o sdg-report.html
    
    - name: Upload SDG Report
      uses: actions/upload-artifact@v4
      with:
        name: sdg-analysis-report
        path: |
          sdg-report.json
          sdg-report.html
    
    - name: SDG Score Check
      run: |
        # SDGスコアが閾値を下回った場合はワークフローを失敗させる
        node -e "
          const report = require('./sdg-report.json');
          const averageScore = report.summary.averageScore;
          console.log(\`Average SDG Score: \${averageScore}/100\`);
          if (averageScore < 70) {
            console.error('SDG score below threshold (70)');
            process.exit(1);
          }
        "
    
    - name: Comment PR with SDG Report
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = JSON.parse(fs.readFileSync('sdg-report.json', 'utf8'));
          
          const comment = `## 🌍 SDGScript Analysis Report
          
          **Summary:**
          - **Total Functions:** ${report.summary.totalFunctions}
          - **SDG Annotated:** ${report.summary.annotatedFunctions}
          - **Violations:** ${report.summary.totalViolations}
          - **Average Score:** ${report.summary.averageScore.toFixed(1)}/100
          
          ${report.summary.averageScore >= 80 ? '✅ Excellent SDG compliance!' : 
            report.summary.averageScore >= 70 ? '⚠️ Good SDG compliance with room for improvement' :
            '❌ Poor SDG compliance - improvements needed'}
          
          [📊 View Full Report](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  build:
    runs-on: ubuntu-latest
    needs: sdg-analysis
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Build packages
      run: npm run build
    
    - name: Run tests
      run: npm test
    
    - name: Run ESLint with SDGScript rules
      run: npx eslint src/ --ext .ts,.tsx
